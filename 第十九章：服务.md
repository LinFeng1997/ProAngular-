## Using Services
服务给其它构建块提供支持。使用依赖注入的方式进行工作。

| 问题 | 答案 | 
| --- | --- |
| 它们是啥？ | 服务是定义其他构建块所需功能的对象,相当于全局功能提供者 |
| 它们有啥用？ | 隔离了应用的模块,便于复用代码和测试 |
| 它们咋用？| 类使用构造函数参数声明对服务的依赖(@Injectable)，然后使用该应用程序的一组服务来解决这些问题。 |
| 它们有坑吗？ | 依赖注入比较复杂 |
| 它们可选吗？ | 服务和依赖项注入是很难避免的，因为NG使用它们提供了对内置功能的访问。 |


| 问题 | 解决方案 |
| --- | --- |
| 避免手动分发共享对象 | 使用服务 | 
| 声明对服务的依赖 | 添加服务需要的构造函数参数 | 

### 准备示例程序
在11章的基础上。

### 理解对象分发问题
在进行应用组件化的时候。防止组件间过度耦合，需要一个全局的工具来帮助分发对象。

####　描述问题
为了描述问题，作者建了一个DiscountService服务作为共享对象。有两个组件依赖它。

* 属性是私有的，get方法是公共的，还有个公共的applyDiscount方法。
* PaDiscountDisplayComponent类注入这个服务并且访问它的discount方法。注册这个组件。
```
@Input("discounter")
discounter: DiscountService;
[(ngModel)]="discounter.discount"
```
* 还可以实例化服务
```
discounter: DiscountService = new DiscountService();
```
* 实例化服务对象有一个问题：无法共享同一个服务对象。要用到继承的知识。

####　使用依赖注入分发对象作为服务
依赖注入这种模式就可以只把外部对象(providers)和使用者关联起来。

### 准备服务
@Injectable的装饰器不定义任何配置属性。
```
@Injectable()
```
#### 准备依赖组件
一个类使用它的构造函数声明依赖关系。

* 不再需要Input属性了，直接在构造函数声明。
```
constructor(private discounter: DiscountService) { }
```
* HTML里也不需要数据绑定了

### 注册服务
引入并注册。
```
providers: [DiscountService]
```
#### 复习依赖注入的变化

* 需要一个使用者，比如组件或者指令
* 需要一个服务(可以是单例)
* 在使用者类使用@Injectable并且在构造函数里声明服务，实现注入
* 这样比实例化好，因为不会产生类的大爆炸，使程序更为灵活

### 在其他构建块声明依赖
可以在组件/管道/指令里使用它。

#### 在管道里声明依赖
引入Injectable和服务然后注入就可以了。

* 例子的transform方法转成价格打折后的样子

#### 在指令里声明依赖
用discountAmount.directive.ts做例子

* 使用生命钩子周期函数检测服务对象的变化,由此来判断是否更新
* exportAs为discount
* 引入了keyValueDiffers和ChangeDetectorRef作为检测复杂对象的变更
* 注册并使用它
```
<td style="vertical-align:middle" [pa-price]="item.price"
        #discount="discount">
    {{ discount.discountAmount | currency:"USD": true }}
</td>
```

### 理解测试隔离问题
在一个组件里实例化一个类的时候,难以进行单元测试。
### 使用服务和依赖注入隔离组件
依赖注入对单元测试是友好的，因为它对服务和组件进行了解耦。
#### 准备服务
使用Injectable并且当装饰器用。
#### 注册服务
必须在app.module注册并写在providers数组里
#### 准备依赖组件
直接在组件的构造参数里声明,私有的。

* 通过其构造函数提供模拟对象。
* 有一个依赖关系的链。在单元测试的时候很方便。

#### 完成服务采用
尽可能地采用这种风格架构，虽然有些人不喜欢它。

##### 更新根组件和模板
移除Model对象。
##### 更新子组件
加入Model对象并注入。解耦了和父组件的关系后，实践了依赖倒置原则。
### 总结
在本章中，作者解释了依赖注入可以用来解决的问题,演示了定义和使用服务的过程。描述了如何使用服务增加应用程序结构的灵活性，以及依赖注入如何使之成为可能隔离构建块们，使它们能够有效地进行单元测试。在下一章中，描述
NG提供服务的特性。
